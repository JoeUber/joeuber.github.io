<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Church Volunteer Scheduler</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/Babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root" class="container mx-auto p-4"></div>

  <script type="text/babel">
    const roles = ['Proclaimer (First Reader)', 'Proclaimer (Second Reader)', 'Sacristan', 'Eucharistic Minister'];
    const masses = ['5pm Saturday Mass', '9am Sunday Mass', '11am Sunday Mass'];
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyLRwB-iapOUm4Yi5iCOOjnF6aDC6P3WfQwasFAf8LW9yAuy8sp9y0jtu5TSwVUb0XL7Q/exec';

    function App() {
      const [schedule, setSchedule] = React.useState([]);
      const [volunteers, setVolunteers] = React.useState([]);
      const [file, setFile] = React.useState(null);
      const [absence, setAbsence] = React.useState({ volunteer: '', role: '', mass: '' });
      const [error, setError] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      const [connectionStatus, setConnectionStatus] = React.useState('Not tested');

      React.useEffect(() => {
        testConnection();
      }, []);

      const testConnection = () => {
        setConnectionStatus('Testing...');
        fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify({ test: true }),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
          return response.json();
        })
        .then(data => {
          setLoading(false);
          if (data.success) {
            setConnectionStatus('Connected to Google Apps Script: ' + (data.message || 'Success'));
          } else {
            setError('Failed to connect to Google Apps Script: ' + (data.error || 'Unknown error'));
            setConnectionStatus('Connection failed');
          }
        })
        .catch(err => {
          setLoading(false);
          setError('Error connecting to backend: ' + err.message);
          setConnectionStatus('Connection error: ' + err.message);
        });
      };

      const handleFileUpload = (event) => {
        try {
          const file = event.target.files[0];
          setFile(file);
          const reader = new FileReader();
          reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);
            const parsedSchedule = json.map(row => ({
              name: row.Name,
              email: row.Email,
              phone: row.Phone,
              role: row.Role,
              mass: row.Mass,
              date: row.Date
            }));
            setSchedule(parsedSchedule);
            const uniqueVolunteers = [...new Set(parsedSchedule.map(item => item.name))].map(name => ({
              name,
              email: parsedSchedule.find(item => item.name === name).email,
              phone: parsedSchedule.find(item => item.name === name).phone
            }));
            setVolunteers(uniqueVolunteers);
            exportToGoogleSheets(json);
          };
          reader.readAsArrayBuffer(file);
        } catch (err) {
          setError('Error processing file: ' + err.message);
        }
      };

      const exportToGoogleSheets = (data) => {
        fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            console.log('Data sent to Google Sheets:', data);
          } else {
            setError('Failed to save to Google Sheets: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => setError('Error sending to Google Sheets: ' + error.message));
      };

      const sendNotifications = (mass, date) => {
        const volunteersForMass = schedule.filter(item => item.mass === mass && item.date === date);
        fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify({ action: 'sendNotifications', volunteers: volunteersForMass, mass, date }),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            alert('Notifications sent successfully');
          } else {
            setError('Failed to send notifications: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => setError('Error sending notifications: ' + error.message));
      };

      const handleAbsence = (e) => {
        e.preventDefault();
        const { volunteer, role, mass } = absence;
        const date = new Date().toISOString().split('T')[0];
        const group = schedule.filter(item => item.role === role);
        fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify({ action: 'sendAbsence', volunteer, role, mass, date, group }),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            alert(`Absence notification sent for ${volunteer}`);
            setAbsence({ volunteer: '', role: '', mass: '' });
          } else {
            setError('Failed to send absence notification: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => setError('Error sending absence notification: ' + error.message));
      };

      return (
        <div className="space-y-6">
          <h1 className="text-3xl font-bold text-center">Church Volunteer Scheduler</h1>
          {error && (
            <div className="text-center text-red-500">
              <p>Error: {error}</p>
              <p>Please check the console for details and verify the Google Apps Script URL.</p>
            </div>
          )}
          <div className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-4">Diagnostics</h2>
            <p>Connection Status: {connectionStatus}</p>
            <button
              onClick={testConnection}
              className="mt-2 bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600"
            >
              Test Connection
            </button>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-4">Upload Schedule (Excel)</h2>
            <input
              type="file"
              accept=".xlsx, .xls"
              onChange={handleFileUpload}
              className="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100"
            />
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-4">Current Schedule</h2>
            <div className="grid grid-cols-1 gap-4">
              {masses.map(mass => (
                <div key={mass} className="border p-4 rounded">
                  <h3 className="text-lg font-medium">{mass}</h3>
                  {roles.map(role => (
                    <div key={role}>
                      <p className="font-semibold">{role}:</p>
                      {schedule
                        .filter(item => item.mass === mass && item.role === role)
                        .map((item, idx) => (
                          <p key={idx}>{item.name} ({item.date})</p>
                        ))}
                    </div>
                  ))}
                  <button
                    onClick={() => sendNotifications(mass, new Date().toISOString().split('T')[0])}
                    className="mt-2 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                  >
                    Send Weekly Notifications
                  </button>
                </div>
              ))}
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-xl font-semibold mb-4">Report Absence</h2>
            <form onSubmit={handleAbsence} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">Volunteer</label>
                <select
                  value={absence.volunteer}
                  onChange={(e) => setAbsence({ ...absence, volunteer: e.target.value })}
                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                >
                  <option value="">Select Volunteer</option>
                  {volunteers.map(vol => (
                    <option key={vol.name} value={vol.name}>{vol.name}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Role</label>
                <select
                  value={absence.role}
                  onChange={(e) => setAbsence({ ...absence, role: e.target.value })}
                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                >
                  <option value="">Select Role</option>
                  {roles.map(role => (
                    <option key={role} value={role}>{role}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Mass</label>
                <select
                  value={absence.mass}
                  onChange={(e) => setAbsence({ ...absence, mass: e.target.value })}
                  className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                >
                  <option value="">Select Mass</option>
                  {masses.map(mass => (
                    <option key={mass} value={mass}>{mass}</option>
                  ))}
                </select>
              </div>
              <button
                type="submit"
                className="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600"
              >
                Report Absence
              </button>
            </form>
          </div>
        </div>
      );
    }

    try {
      ReactDOM.render(<App />, document.getElementById('root'));
    } catch (err) {
      document.getElementById('root').innerHTML = '<div class="text-center text-red-500">Error rendering app: ' + err.message + '. Please check the console and ensure all CDN scripts loaded correctly.</div>';
    }
  </script>
</body>
</html>
